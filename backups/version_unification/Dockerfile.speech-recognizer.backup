# ğŸ—£ï¸ ìŒì„± ì¸ì‹ ì„œë¹„ìŠ¤ - Python 3.11 + CUDA 11.8 + PyTorch 2.1.2 (ê³ ì • ë²„ì „)
FROM nvidia/cuda:11.8.2-cudnn8-devel-ubuntu22.04

# ğŸ Python 3.11 ì„¤ì¹˜
ENV PYTHON_VERSION=3.11
RUN apt-get update && apt-get install -y \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-dev \
    python${PYTHON_VERSION}-distutils \
    python3-pip \
    wget \
    curl \
    git \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Python ì‹¬ë³¼ë¦­ ë§í¬ ì„¤ì •
RUN ln -sf /usr/bin/python${PYTHON_VERSION} /usr/bin/python3 && \
    ln -sf /usr/bin/python3 /usr/bin/python

# pip ì—…ê·¸ë ˆì´ë“œ ë° ìºì‹œ ì •ë¦¬
RUN pip3 install --upgrade pip && pip3 cache purge

# ğŸ”¥ PyTorch 2.1.2 + CUDA 11.8 ì„¤ì¹˜ (ê³ ì • ë²„ì „)
RUN pip3 install --no-cache-dir --timeout 1000 --retries 3 \
    torch==2.1.2 \
    torchaudio==2.1.2 \
    torchvision==0.16.2 \
    --index-url https://download.pytorch.org/whl/cu118

WORKDIR /app

# ğŸ”§ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1 \
    libsox-fmt-all \
    sox \
    build-essential \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ (webrtcvad ë¬¸ì œ í•´ê²°)
COPY requirements.speech-recognizer.txt .
RUN pip install --no-cache-dir --timeout 1000 --retries 3 --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org -r requirements.speech-recognizer.txt --no-deps || pip install --no-cache-dir --timeout 1000 --retries 3 --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org -r requirements.speech-recognizer.txt

# ğŸ¯ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³µì‚¬
COPY src/text/speech_recognizer.py /app/
COPY src/text/model_preloader.py /app/
COPY src/utils/ /app/utils/

# ğŸš€ ì‹¤í–‰
EXPOSE 8003
CMD ["python", "-m", "uvicorn", "speech_recognizer:app", "--host", "0.0.0.0", "--port", "8003"] 