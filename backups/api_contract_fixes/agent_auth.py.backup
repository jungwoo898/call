#!/usr/bin/env python3
"""
Callytics ìƒë‹´ì‚¬ ì¸ì¦ ì‹œìŠ¤í…œ (PostgreSQL ê¸°ë°˜)
ë¡œê·¸ì¸, ê¶Œí•œ ê´€ë¦¬, ì„¸ì…˜ ê´€ë¦¬
"""

import os
import hashlib
import secrets
import logging
import asyncio
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
from dataclasses import dataclass
import jwt

# PostgreSQL ë§¤ë‹ˆì € import
from ..db.postgres_manager import PostgreSQLManager

logger = logging.getLogger(__name__)

@dataclass
class AgentSession:
    """ìƒë‹´ì‚¬ ì„¸ì…˜ ì •ë³´"""
    agent_id: int
    username: str
    full_name: str
    department: str
    position: str
    permissions: List[str]
    session_token: str
    expires_at: datetime

class AgentAuthManager:
    """ìƒë‹´ì‚¬ ì¸ì¦ ê´€ë¦¬ì (PostgreSQL)"""
    
    def __init__(self):
        # ğŸ” ë³´ì•ˆ ê°•í™”: í™˜ê²½ë³€ìˆ˜ì—ì„œ ì‹œí¬ë¦¿ í‚¤ ë¡œë“œ
        self.secret_key = os.getenv("JWT_SECRET_KEY")
        if not self.secret_key:
            if os.getenv("ENVIRONMENT") == "development":
                self.secret_key = secrets.token_urlsafe(32)
                logger.warning("ê°œë°œ í™˜ê²½: ì„ì‹œ JWT ì‹œí¬ë¦¿ í‚¤ ìƒì„±ë¨")
            else:
                raise ValueError("JWT_SECRET_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
        self.session_duration = timedelta(hours=int(os.getenv("SESSION_DURATION_HOURS", "8")))
        self.max_login_attempts = int(os.getenv("MAX_LOGIN_ATTEMPTS", "5"))
        self.account_lock_duration = timedelta(minutes=int(os.getenv("ACCOUNT_LOCK_MINUTES", "30")))
        self.issuer = os.getenv("JWT_ISSUER", "callytics-auth")
        self.audience = os.getenv("JWT_AUDIENCE", "callytics-api")
        # PostgreSQL ë§¤ë‹ˆì €
        self.pg = PostgreSQLManager()
        self.loop = asyncio.get_event_loop()
        self.loop.run_until_complete(self.pg.initialize())

    def auth_hash_password(self, password: str) -> str:
        """ë¹„ë°€ë²ˆí˜¸ í•´ì‹œí™”"""
        salt = secrets.token_hex(16)
        hash_obj = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), salt.encode('utf-8'), 100000)
        return f"{salt}${hash_obj.hex()}"

    def auth_verify_password(self, password: str, hashed_password: str) -> bool:
        """ë¹„ë°€ë²ˆí˜¸ ê²€ì¦"""
        try:
            salt, hash_hex = hashed_password.split('$')
            hash_obj = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), salt.encode('utf-8'), 100000)
            return hash_obj.hex() == hash_hex
        except:
            return False

    def auth_create_agent_account(self, username: str, email: str, password: str, 
                           full_name: str, department: str, position: str, 
                           employee_id: str = None) -> Optional[int]:
        """ìƒë‹´ì‚¬ ê³„ì • ìƒì„± (ë™ê¸°)"""
        return self.loop.run_until_complete(
            self.create_agent_account_async(username, email, password, full_name, department, position, employee_id)
        )

    async def create_agent_account_async(self, username: str, email: str, password: str, 
                                         full_name: str, department: str, position: str, 
                                         employee_id: str = None) -> Optional[int]:
        try:
            hashed_password = self.auth_hash_password(password)
            async with self.pg.get_connection() as conn:
                # ê³„ì • ìƒì„±
                account_id = await conn.fetchval("""
                    INSERT INTO agent_accounts (username, email, password_hash)
                    VALUES ($1, $2, $3)
                    RETURNING id
                """, username, email, hashed_password)
                # í”„ë¡œí•„ ìƒì„±
                agent_id = await conn.fetchval("""
                    INSERT INTO agent_profiles (account_id, employee_id, full_name, first_name, last_name, department, position)
                    VALUES ($1, $2, $3, $4, $5, $6, $7)
                    RETURNING id
                """, account_id, employee_id, full_name, full_name.split()[0], ' '.join(full_name.split()[1:]), department, position)
                # ê¸°ë³¸ ê¶Œí•œ ë¶€ì—¬
                await conn.execute("""
                    INSERT INTO agent_permissions (agent_id, permission_type, permission_level)
                    VALUES ($1, 'audio_upload', 'write')
                """, agent_id)
                await conn.execute("""
                    INSERT INTO agent_permissions (agent_id, permission_type, permission_level)
                    VALUES ($1, 'analysis_view', 'read')
                """, agent_id)
                # ê¸°ë³¸ ì„¤ì • ìƒì„±
                await conn.execute("""
                    INSERT INTO agent_settings (agent_id)
                    VALUES ($1)
                """, agent_id)
                logger.info(f"ìƒë‹´ì‚¬ ê³„ì • ìƒì„± ì™„ë£Œ: {username} ({full_name})")
                return agent_id
        except Exception as e:
            logger.error(f"ê³„ì • ìƒì„± ì‹¤íŒ¨: {e}")
            return None

    def auth_authenticate_agent(self, username: str, password: str) -> Optional[AgentSession]:
        """ìƒë‹´ì‚¬ ì¸ì¦ (ë™ê¸°)"""
        return self.loop.run_until_complete(self.authenticate_agent_async(username, password))

    async def authenticate_agent_async(self, username: str, password: str) -> Optional[AgentSession]:
        try:
            async with self.pg.get_connection() as conn:
                row = await conn.fetchrow("""
                    SELECT aa.*, ap.*
                    FROM agent_accounts aa
                    JOIN agent_profiles ap ON aa.id = ap.account_id
                    WHERE aa.username = $1 AND aa.account_status = 'active'
                """, username)
                if not row:
                    logger.warning(f"ì¸ì¦ ì‹¤íŒ¨: ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - {username}")
                    return None
                # ê³„ì • ì ê¸ˆ í™•ì¸
                if row['account_locked_until'] and datetime.fromisoformat(str(row['account_locked_until'])) > datetime.now():
                    logger.warning(f"ì¸ì¦ ì‹¤íŒ¨: ê³„ì • ì ê¸ˆ - {username}")
                    return None
                # ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
                if not self.auth_verify_password(password, row['password_hash']):
                    # ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜ ì¦ê°€
                    await conn.execute("""
                        UPDATE agent_accounts 
                        SET login_attempts = login_attempts + 1
                        WHERE id = $1
                    """, row['id'])
                    # 5íšŒ ì‹¤íŒ¨ì‹œ ê³„ì • ì ê¸ˆ
                    if row['login_attempts'] >= 4:
                        lock_until = datetime.now() + self.account_lock_duration
                        await conn.execute("""
                            UPDATE agent_accounts 
                            SET account_locked_until = $1
                            WHERE id = $2
                        """, lock_until.isoformat(), row['id'])
                        logger.warning(f"ê³„ì • ì ê¸ˆ: {username} (5íšŒ ì‹¤íŒ¨)")
                    logger.warning(f"ì¸ì¦ ì‹¤íŒ¨: ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ - {username}")
                    return None
                # ë¡œê·¸ì¸ ì„±ê³µ - ì‹¤íŒ¨ íšŸìˆ˜ ì´ˆê¸°í™”
                await conn.execute("""
                    UPDATE agent_accounts 
                    SET login_attempts = 0, account_locked_until = NULL, last_login_at = CURRENT_TIMESTAMP
                    WHERE id = $1
                """, row['id'])
                # ê¶Œí•œ ì¡°íšŒ
                perm_rows = await conn.fetch("""
                    SELECT permission_type, permission_level
                    FROM agent_permissions
                    WHERE agent_id = $1 AND is_active = TRUE
                """, row['id'])
                permissions = [f"{r['permission_type']}:{r['permission_level']}" for r in perm_rows]
                # ì„¸ì…˜ í† í° ìƒì„±
                session_token = secrets.token_urlsafe(32)
                expires_at = datetime.now() + self.session_duration
                return AgentSession(
                    agent_id=row['id'],
                    username=row['username'],
                    full_name=row['full_name'],
                    department=row['department'],
                    position=row['position'],
                    permissions=permissions,
                    session_token=session_token,
                    expires_at=expires_at
                )
        except Exception as e:
            logger.error(f"ì¸ì¦ ì‹¤íŒ¨: {e}")
            return None

    # ì´í•˜ validate_session, create_session_token, logout_agent ë“±ë„ ë™ì¼í•˜ê²Œ asyncpg ê¸°ë°˜ìœ¼ë¡œ ë¦¬íŒ©í† ë§ í•„ìš”

    def auth_validate_session(self, session_token: str) -> Optional[AgentSession]:
        """ì„¸ì…˜ ê²€ì¦"""
        # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Redisë‚˜ DBì— ì„¸ì…˜ ì •ë³´ ì €ì¥
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ JWT í† í° ì‚¬ìš©
        try:
            payload = jwt.decode(session_token, self.secret_key, algorithms=['HS256'])
            
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT ap.*, aa.username
                    FROM agent_profiles ap
                    JOIN agent_accounts aa ON ap.account_id = aa.id
                    WHERE ap.id = ? AND ap.is_active = 1 AND aa.account_status = 'active'
                """, (payload['agent_id'],))
                
                row = cursor.fetchone()
                if not row:
                    return None
                
                # ê¶Œí•œ ì¡°íšŒ
                cursor.execute("""
                    SELECT permission_type, permission_level
                    FROM agent_permissions
                    WHERE agent_id = ? AND is_active = 1
                """, (payload['agent_id'],))
                
                permissions = [f"{row['permission_type']}:{row['permission_level']}" for row in cursor.fetchall()]
                
                return AgentSession(
                    agent_id=row['id'],
                    username=row['username'],
                    full_name=row['full_name'],
                    department=row['department'],
                    position=row['position'],
                    permissions=permissions,
                    session_token=session_token,
                    expires_at=datetime.fromisoformat(payload['expires_at'])
                )
                
        except jwt.ExpiredSignatureError:
            logger.warning("ì„¸ì…˜ ë§Œë£Œ")
            return None
        except jwt.InvalidTokenError:
            logger.warning("ì˜ëª»ëœ ì„¸ì…˜ í† í°")
            return None
        except Exception as e:
            logger.error(f"ì„¸ì…˜ ê²€ì¦ ì‹¤íŒ¨: {e}")
            return None
    
    def auth_create_session_token(self, agent_session: AgentSession) -> str:
        """ì„¸ì…˜ í† í° ìƒì„±"""
        payload = {
            'agent_id': agent_session.agent_id,
            'username': agent_session.username,
            'expires_at': agent_session.expires_at.isoformat(),
            'exp': agent_session.expires_at.timestamp()
        }
        return jwt.encode(payload, self.secret_key, algorithm='HS256')
    
    def auth_logout_agent(self, agent_id: int, session_token: str):
        """ë¡œê·¸ì•„ì›ƒ"""
        try:
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                
                # í™œë™ ë¡œê·¸ ê¸°ë¡
                cursor.execute("""
                    INSERT INTO agent_activity_logs (agent_id, activity_type, activity_description)
                    VALUES (?, 'logout', 'ë¡œê·¸ì•„ì›ƒ')
                """, (agent_id,))
                
                conn.commit()
                logger.info(f"ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ: agent_id={agent_id}")
                
        except Exception as e:
            logger.error(f"ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
    
    def auth_get_agent_permissions(self, agent_id: int) -> List[str]:
        """ìƒë‹´ì‚¬ ê¶Œí•œ ì¡°íšŒ"""
        try:
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT permission_type, permission_level
                    FROM agent_permissions
                    WHERE agent_id = ? AND is_active = 1
                """, (agent_id,))
                
                return [f"{row['permission_type']}:{row['permission_level']}" for row in cursor.fetchall()]
                
        except Exception as e:
            logger.error(f"ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            return []
    
    def auth_check_permission(self, agent_id: int, permission_type: str, required_level: str = 'read') -> bool:
        """ê¶Œí•œ í™•ì¸"""
        permissions = self.auth_get_agent_permissions(agent_id)
        
        for permission in permissions:
            perm_type, perm_level = permission.split(':')
            if perm_type == permission_type:
                if required_level == 'read' and perm_level in ['read', 'write', 'admin']:
                    return True
                elif required_level == 'write' and perm_level in ['write', 'admin']:
                    return True
                elif required_level == 'admin' and perm_level == 'admin':
                    return True
        
        return False
    
    def auth_log_activity(self, agent_id: int, activity_type: str, description: str = None, 
                    ip_address: str = None, user_agent: str = None, activity_data: str = None):
        """í™œë™ ë¡œê·¸ ê¸°ë¡"""
        try:
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO agent_activity_logs 
                    (agent_id, activity_type, activity_description, ip_address, user_agent, activity_data)
                    VALUES (?, ?, ?, ?, ?, ?)
                """, (agent_id, activity_type, description, ip_address, user_agent, activity_data))
                
                conn.commit()
                
        except Exception as e:
            logger.error(f"í™œë™ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨: {e}")
    
    def auth_get_agent_profile(self, agent_id: int) -> Optional[Dict[str, Any]]:
        """ìƒë‹´ì‚¬ í”„ë¡œí•„ ì¡°íšŒ"""
        try:
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT ap.*, aa.username, aa.email, aa.last_login_at
                    FROM agent_profiles ap
                    JOIN agent_accounts aa ON ap.account_id = aa.id
                    WHERE ap.id = ?
                """, (agent_id,))
                
                row = cursor.fetchone()
                if row:
                    return dict(row)
                return None
                
        except Exception as e:
            logger.error(f"í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            return None
    
    def auth_update_agent_profile(self, agent_id: int, **kwargs) -> bool:
        """ìƒë‹´ì‚¬ í”„ë¡œí•„ ì—…ë°ì´íŠ¸"""
        try:
            with self.get_db_connection() as conn:
                cursor = conn.cursor()
                
                # ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ í•„ë“œë“¤
                allowed_fields = ['full_name', 'first_name', 'last_name', 'department', 'position', 
                                'team', 'specialization', 'contact_number', 'bio']
                
                update_fields = []
                update_values = []
                
                for field, value in kwargs.items():
                    if field in allowed_fields and value is not None:
                        update_fields.append(f"{field} = ?")
                        update_values.append(value)
                
                if not update_fields:
                    return False
                
                update_values.append(agent_id)
                
                cursor.execute(f"""
                    UPDATE agent_profiles 
                    SET {', '.join(update_fields)}, updated_at = CURRENT_TIMESTAMP
                    WHERE id = ?
                """, update_values)
                
                conn.commit()
                logger.info(f"í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ: agent_id={agent_id}")
                return True
                
        except Exception as e:
            logger.error(f"í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")
            return False 